<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="pathfinding-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.5/js/jsplumb.min.js" integrity="sha512-PjminIGk9jefzK8KKri4U44KYMW4C4WZNTY/4dB33FwkoY5pSF7GL+ZIvz8t61QsY5h30gfWZ0IJ4h/yQVoRyA==" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="data_2px.js"></script>
    <script type="text/javascript">
        var matrix = TwoPxMatrix
       // https://i.imgur.com/0rXuTeO.jpg
    </script>
    <style>
        .cell { 
            width: 15px;
            height: 15px;
            margin: 1px;
            position: absolute;
            background-color: none;
        }

        #container {
            width: 100px;
            height: 100px;
            background: url("https://i.imgur.com/lca1ENM.jpg");
            background-repeat: no-repeat;
            background-size: contain;
            position: relative;
        }

        body {
            margin: 0;
        }
    </style>
</head>
<body>
    <input type="number" id="entryX" placeholder="entry X">
    <input type="number" id="entryY" placeholder="entry Y">
    <input type="number" id="exitX" placeholder="exit X">
    <input type="number" id="exitY" placeholder="exit Y">
    <input type="button" value="launch" onclick="launch()">
    <span>Activer les coordonnées automatiques (BETA)</span>
    <input type="checkbox" id="instantPathCheck" aria-label="Si problème, rechargez la page">
    <div id="coords"></div>
    <div id="container">
    </div>
    <script>
        var placeCounter = 1
        
        // {"Name": [firstX, lastX, firstY, lastY]}
        var limits = {
            "pro": [0, 27, 0, 69],
            "bat1_2": [28, 48, 0, 68],
            "s_entry": [49, 54, 0, 68],
            "admin": [55, 69, 41, 68],
            "n_entry": [55, 106, 0, 20],
            "bat3": [55, 69, 21, 40],
            "self": [70, 106, 21, 69],
        }

        var doors = {
            "bat1": [
                [133, 149],
                [134, 149],
                [135, 149],
                [139, 149],
                [149, 148],
                [150, 149],
                [151, 149]
            ],
            "bat2": [
                [164, 135],
                [166, 169],
                [186, 135],
                [187, 135],
                [189, 135]
            ],
            "bat3": [
                [263, 68],
                [261, 63],
                [262, 165],
                [262, 167],
                [252, 110],
                [254, 109],
                [263, 63],
                [275, 111],
                [274, 109],
                [281, 109],
            ],
            "bat13": [
                [213, 113],
                [203, 139],
                [205, 133],
                [206, 135],
                [207, 143],
                [207, 131],
                [208, 144],
                [209, 144],
                [211, 115],
                [212, 114],
                [221, 153],
                [222, 156],
                [222, 158],
                [223, 161],
                [224, 119],
                [224, 158],
                [226, 159],
            ],
        }

        var container = document.getElementById("container")

        function calculatePath(finder, grid) {
            var entry = [document.getElementById("entryX").value || 242, document.getElementById("entryY").value || 64]
            var exit = [document.getElementById("exitX").value || 224, document.getElementById("exitY").value || 178]
            return finder.findPath(entry[0], entry[1], exit[0], exit[1], grid);
        }

        function approxEqual(v1, v2, ap) {
            if (ap == null) {
                ap = 1
            }
            if (v1 == v2) {
                return true
            }
            return Math.abs(v1 - v2) <= ap
        }

        var squareSize = 2
        var squareNumber = matrix.length / squareSize
        var size = window.innerHeight / matrix.length

        function launch() {
            container.style.width = "auto"
            container.style.height = window.innerHeight + "px"

            container.addEventListener("click", function (evt) {
                var offset = $('#container').offset()
                var coX = parseInt((evt.pageX - offset.left)/size)
                var coY = parseInt((evt.pageY - offset.top)/size)
                $('#coords').text(coX + "," + coY)
                if (matrix[coY][coX] == 1) {
                    console.log("Unwalkable")
                    $('#coords').css('color', 'orangered')
                } else {
                    if (document.getElementById("instantPathCheck").checked) {
                        if (placeCounter > 2) {
                            placeCounter = 1
                            if (document.getElementsByClassName("start")[0]) {
                                document.getElementsByClassName("start")[0].remove()
                            }
                            if (document.getElementsByClassName("exit")[0]) {
                                document.getElementsByClassName("exit")[0].remove()
                            }
                        } else {
                            console.log(placeCounter)
                            if (placeCounter == 1) {
                                placeDiv(coX, coY, "green", "start")
                                $("#entryX").val(coX)
                                $("#entryY").val(coY)
                            } if (placeCounter == 2) {
                                placeDiv(coX, coY, "red", "exit")
                                $("#exitX").val(coX)
                                $("#exitY").val(coY)
                                launch()
                            }
                            placeCounter++
                        }
                    }
                    console.log("Walkable")
                    $('#coords').css('color', 'green')
                }
                console.log([coX, coY]);
            }, false)

            var grid = new PF.Grid(matrix);
            var finder = new PF.AStarFinder({
                diagonalMovement : PF.DiagonalMovement.Always,
                dontCrossCorners: true,
            });

            jsPlumb.deleteEveryConnection()
            container.innerHTML = ''
            var path = calculatePath(finder, grid)
            var newPath = PF.Util.smoothenPath(grid, path)
            console.log(newPath)

            for (newCoords in newPath){
                placeDiv(newPath[newCoords][0], newPath[newCoords][1], "none", "")
            }

            var dynamicAnchors = [[0.5,0.5,0,-1], [0.5,0.5, 1, 0], [0.5,0.5, 0, 1], [0.5,0.5,-1,0]]

            jsPlumb.ready(function() {
                jsPlumb.importDefaults({
                    Container: "container"
                })
                var inBat = false
                for (co in newPath) {
                    if (newPath[co - 1] != null) {
                        if (inBat) {
                            jsPlumb.connect({
                                source:newPath[co - 1].toString(),
                                target:newPath[co].toString(),
                                anchor: dynamicAnchors,
                                endpoint:"Blank",
                                connector:["Straight"],
                                paintStyle:{strokeWidth:3, stroke:'red',  dashstyle: '3'} 
                            })
                        } else {
                            jsPlumb.connect({
                                source:newPath[co - 1].toString(),
                                target:newPath[co].toString(),
                                anchor: dynamicAnchors,
                                endpoint:"Blank",
                                connector:["Straight"],
                                paintStyle:{strokeWidth:3, stroke:'red'} 
                            })
                        }
                        for (bat in doors) {
                            for (porte in doors[bat]) {
                                if (approxEqual(doors[bat][porte][0],newPath[co][0]) && approxEqual(doors[bat][porte][1], newPath[co][1])) {
                                    inBat = !inBat
                                    console.log(inBat, doors[bat][porte], co, newPath[co])
                                    break
                                }
                            }
                        }
                    }
                }
            })
        }

        function placeDiv(x, y, color, classE) {
            var offset = $('#container').offset()
            var xPos = parseInt(x*size)
            var yPos = parseInt(y*size)
            var s = `<div id="` + x + `,` + y + `" class="cell ` + classE + `" style="left: ` + xPos + `px; top: ` + yPos + `px; background-color: ` + color + `"> </div>`
            container.innerHTML += s
        }

        function buildGrid(startx, starty, endx, endy) {
            while (starty < endy) {
                while (startx < endx) {
                    if (matrix[starty][startx] == 1) {
                        placeDiv(startx, starty, "black", "")
                    } 
                    startx++
                }
                starty++
            }
        }
        launch()
    </script>
</body>
</html>